# Code Review – hyperclayjs

## Critical issues

1. **Dynamic loader never runs most modules** (`hyperclay.js:355-358`, e.g. `custom-attributes/ajaxElements.js:62-65`). The loader only calls a named `init` export, but every feature module either exports a default function or just helper functions with no `init` binding, so nothing ever executes when a feature is requested. The starter kit therefore downloads modules and then drops them on the floor. Consider calling `loaded.default` when it is a function, or standardising on `export function init()` across the codebase so the loader actually initialises each feature.
2. **The “admin” feature is completely inert** (`core/adminContenteditable.js:5-30`, `core/adminInputs.js:5-40`, `core/adminResources.js:5-28`, `core/adminOnClick.js:5-24`). Even if the loader issue is fixed, these files only export helper functions and never invoke them or expose an `init`. Loading the `admin` preset therefore does nothing: inputs stay readonly, scripts remain inert, etc. These modules need an entrypoint (e.g. export an `init` that registers the before-save hooks and DOM-ready handlers) so the advertised functionality actually runs.

## High priority issues

3. **`ajaxElements` cannot load and mis-serialises requests** (`custom-attributes/ajaxElements.js:1-48`). It imports `../dom/getDataFromForm.js`, a path that does not exist (the helper lives in `dom-utilities`). Even after fixing the import, `submitAjax` blindly reads `action`/`method` from the element you clicked; buttons do not have those attributes and forms often omit them, so `fetch()` is called with `url === null` and `method === null`, and the body is built from a single button instead of the surrounding form. Default `method` to `'POST'`, use the element’s `.action`/`.method` fallbacks (or its `form` owner), and serialise `elem.closest('form')` so `[ajax-button]` works.
4. **Calling `sendMessage` without a form crashes** (`communication/sendMessage.js:9-18`, `dom-utilities/getDataFromForm.js:45-56`). When the handler is bound to an element that is not inside a `<form>` (or invoked programmatically), `form` becomes `null`, but `getDataFromForm` still dereferences `container.hasAttribute(...)` and throws. Add null guards before serialising, and consider surfacing a user-facing error when the form cannot be found.
5. **`enablePersistentFormInputValues` never persists `<select>` state** (`core/enablePersistentFormInputValues.js:4-35`). The logic only writes a `value` attribute, which is ignored by `<select>` elements—the selected option is controlled via `selected`. Users therefore lose dropdown selections after a save/page reload. Persist by toggling the `selected` attribute on the chosen `<option>` (including multi-select cases) before saving.
6. **`savePage` never marks unsaved changes outside of autosave** (`core/savePage.js:23-170`). `unsavedChanges` is only set inside `savePageThrottled` (line 91). If a project opts out of `initSavePageOnChange`, or if MutationObserver never fires, edits made through the keyboard shortcut or manual saves will never set the flag and users can navigate away with no warning. Track dirty state inside `savePage` whenever `currentContents !== lastSavedContents`, and/or expose an explicit API to set it.
7. **CodeMirror pages skip all sanitisation hooks** (`core/savePageCore.js:35-57`). When CodeMirror is detected, the code returns the editor value directly and never runs `[onbeforesave]`, `[save-ignore]`, or any registered `beforeSave` callbacks. That means admin-only markup (scripts, onclick handlers, edit-mode attributes) leaks into saved HTML whenever a CodeMirror editor is used. You need to run the same cleanup pipeline for CodeMirror exports (e.g. inject the editor value into a cloned document before invoking the hooks).
8. **Prototype extensions in `domHelpers` are not re-entrant and can throw** (`custom-attributes/domHelpers.js:7-65`). The getters/setters are added without `configurable: true`, so calling `init()` twice (or importing the module twice in dev) raises `TypeError: Cannot redefine property 'nearest'`. The setters also assume `nearest(...)` always returns an element; when it does not, `foundElem.setAttribute(...)` throws. Mark the properties configurable and guard against missing targets.
9. **`onclone` does not handle deep clones and re-patches `Node.prototype`** (`custom-attributes/onclone.js:1-23`). Every `init()` call overwrites `Node.prototype.cloneNode` again because the code never checks whether it was already patched. In addition, `processOnclone` only runs on the top-level clone, so `[onclone]` attributes deeper in the subtree never fire when `cloneNode(true)` is used. Keep a single patched function and iterate `element.querySelectorAll('[onclone]')` so nested elements run their hooks.
10. **Behaviour collector misses blur/scroll data** (`communication/behaviorCollector.js:6-185`). The structure exposes `interactions.blurEvents`, but there is no `blur` listener, so the array stays empty. The scroll listener is attached to `document` (line 75), but browser scroll events fire on `window`, so scroll counts and depth stay zero. Hook `window` and add the missing `blur` handler so the telemetry you send matches the schema.
11. **File upload utilities crash on common edge cases** (`communication/uploadFile.js:11-155`, `167-183`). Both `uploadFile` and `uploadFileBasic` assume `files[0]` exists and immediately access `file.size`, so cancelling the file picker throws. The catch block at line 151 blindly does `JSON.parse(error.response)` which itself throws if the server returned HTML, masking the real error and leaving `toast` uncalled. `createFileFromData` also assumes `res.urls` exists (`line 179`). Add guards for missing files, wrap JSON parsing in try/catch, and tolerate responses without URLs.
12. **Modal helpers replace the API they intend to use** (`ui/info.js:24-31`, `ui/prompts.js:52-57`). Both modules assign `themodal.onNo = () => reject()`, overwriting the registration method that pushes callbacks into the internal array. As a result, the rejection handler never runs and the next consumer of `themodal` inherits the overwritten function. Always call `themodal.onNo(() => reject())` (and similarly for other hooks) instead of replacing the function.

## Medium priority issues

13. **`All()`’s chaining semantics break with common inputs** (`dom-utilities/All.js:15-29`, `254-337`). Array-returning methods such as `map` and custom plugins always wrap their results back into a DOM proxy, even when the data are plain strings/booleans. Calling `All('div').map(el => el.id).join(',')` therefore fails because the proxy tries to treat IDs as elements. In addition, `All(selector, context)` currently takes the globally matched `selector` elements and then filters them by `context`, which is the opposite of jQuery semantics (you expect `context` to define where the selector runs). Finally, `toElementArray` rejects NodeLists/HTMLCollections, so `All(document.querySelectorAll('.foo'))` throws even though that is a standard DOM API result. Relax the input handling and fix the context filtering so `All` behaves as documented.

