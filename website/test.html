<!DOCTYPE html>
<html lang="en" showhiddenthing="true">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HyperclayJS Test Suite</title>
  <script>
    // Ensure editmode=true query parameter is present
    if (!window.location.search.includes('editmode=true')) {
      const url = new URL(window.location);
      url.searchParams.set('editmode', 'true');
      window.location.href = url.toString();
    }
  </script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      max-width: 900px; margin: 40px auto; padding: 0 20px;
      line-height: 1.6; color: #333;
    }
    h1 { margin-bottom: 30px; font-size: 2em; }
    h2 {
      margin: 30px 0 15px; padding-bottom: 8px;
      border-bottom: 2px solid #ddd; font-size: 1.4em;
    }
    .test {
      margin: 10px 0; padding: 10px;
      background: #f9f9f9; border-left: 3px solid #ccc;
      display: flex; align-items: center; gap: 10px;
    }
    .test.pass { border-color: #4caf50; }
    .test .check { color: #4caf50; font-weight: bold; font-size: 1.2em; }
    .test .label { font-weight: 500; }
    .test .detail { color: #666; font-size: 0.9em; }
    button {
      padding: 8px 16px; margin: 5px;
      border: 2px solid #333; background: #fff;
      cursor: pointer; font-size: 14px;
    }
    button:hover { background: #f0f0f0; }
    input, textarea {
      padding: 8px; border: 2px solid #ddd;
      font-family: inherit; font-size: 14px;
    }
    .sortable-list { list-style: none; }
    .sortable-list li {
      padding: 10px; margin: 5px 0;
      background: #fff; border: 2px solid #ddd;
      cursor: move;
    }
    .interactive-zone {
      padding: 20px; margin: 10px 0;
      border: 2px dashed #999; background: #fff;
    }
    #behavior-collector-count { font-weight: bold; color: #4caf50; }
  </style>
</head>
<body>
  <h1>HyperclayJS Test Suite</h1>
  <p>Comprehensive visual test of all HyperclayJS modules. Green checkmarks (✓) indicate passing tests.</p>

  <!-- CORE FEATURES -->
  <h2>Core Features</h2>

  <div class="test" id="test-save-core">
    <span class="label">save-core:</span>
    <span class="detail">Checking savePage() function...</span>
  </div>

  <div class="test" id="test-save">
    <span class="label">save:</span>
    <span class="detail">Checking save system...</span>
  </div>

  <div class="test" id="test-admin">
    <span class="label">admin:</span>
    <span class="detail">Admin elements visible in edit mode...</span>
    <div edit-mode-contenteditable contenteditable style="display: inline; margin-left: 10px;">[admin element]</div>
  </div>

  <div class="test" id="test-persist">
    <span class="label">persist:</span>
    <input type="text" persist placeholder="Type here..." id="persist-input">
    <span class="detail" id="persist-status"></span>
  </div>

  <div class="test" id="test-options">
    <span class="label">options:</span>
    <span option:showhiddenthing="true" id="option-test">✓ Option visibility working</span>
  </div>

  <div class="test" id="test-editmode">
    <span class="label">editmode:</span>
    <span class="detail" id="editmode-status"></span>
  </div>

  <!-- CUSTOM ATTRIBUTES -->
  <h2>Custom Attributes</h2>

  <div class="test" id="test-onrender">
    <span class="label">onrender:</span>
    <div onrender="this.textContent='✓ onrender executed'"></div>
  </div>

  <div class="test" id="test-onclone">
    <span class="label">onclone:</span>
    <button onclick="testClone()">Test Clone</button>
    <div id="clone-template" onclone="this.textContent='✓ Cloned at ' + new Date().toLocaleTimeString()" style="display:none;">Template</div>
    <div id="clone-output"></div>
  </div>

  <div class="test" id="test-onclickaway">
    <span class="label">onclickaway:</span>
    <div class="interactive-zone" onclickaway="this.textContent='✓ onclickaway fired'; markPass('test-onclickaway', 'onclickaway fired')" style="cursor: pointer;">
      Click outside this box to test onclickaway
    </div>
  </div>

  <div class="test" id="test-ajax">
    <span class="label">ajax:</span>
    <span class="detail" id="ajax-status"></span>
  </div>

  <div class="test" id="test-sortable">
    <span class="label">sortable:</span>
    <ul class="sortable-list" sortable onsorted="markPass('test-sortable', 'Item sorted')">
      <li>✓ Drag me (1)</li>
      <li>✓ Drag me (2)</li>
      <li>✓ Drag me (3)</li>
    </ul>
  </div>

  <div class="test" id="test-helpers">
    <span class="label">helpers (nearest, val, text, exec, cycle):</span>
    <button onclick="testHelpers()" id="helper-btn" testattr="initial">Test Helpers</button>
    <span class="detail" id="helpers-output" helpertext=""></span>
  </div>

  <div class="test" id="test-inputs">
    <span class="label">inputs (prevent-enter, autosize):</span>
    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
      <textarea prevent-enter placeholder="Type here, press Enter (prevented)" style="width: 250px;"></textarea>
      <textarea autosize placeholder="Type here (auto-resizes)" style="width: 250px;"></textarea>
    </div>
    <span class="detail" id="inputs-status"></span>
  </div>

  <!-- UI COMPONENTS -->
  <h2>UI Components</h2>

  <div class="test" id="test-toast">
    <span class="label">toast:</span>
    <button onclick="testToast()">Test Toast</button>
  </div>

  <div class="test" id="test-prompts">
    <span class="label">prompts (ask, consent, tell, snippet):</span>
    <button onclick="testAsk()">ask()</button>
    <button onclick="testConsent()">consent()</button>
    <button onclick="testTell()">tell()</button>
    <button onclick="testSnippet()">snippet()</button>
  </div>

  <div class="test" id="test-modals">
    <span class="label">theModal:</span>
    <button onclick="testTheModal()">Test theModal</button>
    <span class="detail" id="modals-status"></span>
  </div>


  <!-- STRING UTILITIES -->
  <h2>String Utilities</h2>

  <div class="test" id="test-slugify">
    <span class="label">slugify:</span>
    <span class="detail" id="slugify-output"></span>
  </div>

  <div class="test" id="test-clipboard">
    <span class="label">copy-to-clipboard:</span>
    <button onclick="testClipboard()">Test Copy</button>
  </div>

  <div class="test" id="test-query">
    <span class="label">query-parser:</span>
    <span class="detail" id="query-output"></span>
  </div>

  <!-- DOM UTILITIES -->
  <h2>DOM Utilities</h2>

  <div class="test" id="test-jquery-like">
    <span class="label">jquery-like (All):</span>
    <span class="detail" id="all-output"></span>
  </div>

  <div class="test" id="test-style-injection">
    <span class="label">style-injection:</span>
    <span class="detail test-style-injected">✓ Style injected successfully</span>
  </div>

  <div class="test" id="test-dom-ready">
    <span class="label">dom-ready/window-load:</span>
    <span class="detail" id="ready-status"></span>
  </div>

  <!-- UTILITIES -->
  <h2>Utilities</h2>

  <div class="test" id="test-mutation">
    <span class="label">mutation:</span>
    <span class="detail" id="mutation-status"></span>
  </div>

  <div class="test" id="test-nearest">
    <span class="label">nearest:</span>
    <span class="detail" id="nearest-status"></span>
  </div>

  <div class="test" id="test-cookie">
    <span class="label">cookie:</span>
    <span class="detail" id="cookie-status"></span>
  </div>

  <div class="test" id="test-throttle-debounce">
    <span class="label">throttle/debounce:</span>
    <span class="detail" id="throttle-status"></span>
  </div>

  <!-- COMMUNICATION -->
  <h2>Communication</h2>

  <div class="test" id="test-behavior">
    <span class="label">behaviorCollector:</span>
    <span class="detail">Move your mouse! Positions tracked: <span id="behavior-collector-count">0</span></span>
  </div>

  <div class="test" id="test-communication">
    <span class="label">send-message/file-upload:</span>
    <span class="detail" id="communication-status"></span>
  </div>

  <!-- Load HyperclayJS with everything preset -->
  <script>
    // Enable test mode to prevent actual save requests
    window.hyperclay = window.hyperclay || {};
    window.hyperclay.testMode = true;
  </script>
  <script type="module">
    // Use await import to ensure modules finish loading before running tests
    await import('./dist/hyperclay.js?preset=everything');

    const features = Object.keys(window.hyperclayModules || {});
    console.log('HyperclayJS loaded:', features);

    window.markPass = function(id, message = '') {
      const el = document.getElementById(id);
      el.classList.add('pass');
      const detail = el.querySelector('.detail');
      if (detail && message) {
        detail.innerHTML = `<span class="check">✓</span> ${message}`;
      } else if (message) {
        el.innerHTML += ` <span class="check">✓</span> ${message}`;
      } else {
        const check = document.createElement('span');
        check.className = 'check';
        check.textContent = '✓';
        el.prepend(check);
      }
    };

    // Run tests after markPass is defined
    runTests();

    function runTests() {
      const modules = window.hyperclayModules;

      // Core Features
      if (window.hyperclay?.savePage) markPass('test-save-core', 'savePage() function exists');
      if (modules?.['save-system']) markPass('test-save', 'Save system initialized (Ctrl+S, save button handler)');
      markPass('test-admin', 'Admin elements visible');

      // Persist test - programmatic test
      const persistInput = document.getElementById('persist-input');
      const persistStatus = document.getElementById('persist-status');

      function updatePersistStatus() {
        const persistedValue = persistInput.getAttribute('value') || '';
        const displayValue = persistedValue || '(empty)';

        if (persistInput.getAttribute('value') === persistInput.value) {
          persistStatus.innerHTML = `<span class="check">✓</span> Persisted value: <code>${displayValue}</code>`;
          document.getElementById('test-persist').classList.add('pass');
        } else {
          persistStatus.innerHTML = `Persisted value: <code>${displayValue}</code>`;
        }
      }

      persistInput.addEventListener('input', updatePersistStatus);

      // Programmatically test persist functionality
      setTimeout(() => {
        persistInput.value = 'test-value';
        persistInput.dispatchEvent(new Event('input', { bubbles: true }));

        // Check after a brief delay to ensure persist ran
        setTimeout(() => {
          updatePersistStatus();
        }, 50);
      }, 100);

      // Option visibility
      const optionTest = document.getElementById('option-test');
      if (getComputedStyle(optionTest).visibility !== 'hidden') {
        markPass('test-options');
      }

      // Edit mode
      const editmode = document.documentElement.getAttribute('editmode');
      if (editmode !== null) {
        markPass('test-editmode', `editmode="${editmode}"`);
      } else {
        document.getElementById('editmode-status').textContent = 'editmode not detected';
      }

      // Custom Attributes - onrender is self-testing
      if (document.querySelector('[onrender]')?.textContent.includes('✓')) {
        markPass('test-onrender');
      }

      // AJAX
      if (window.hyperclayModules?.['ajax-elements']) markPass('test-ajax', 'AJAX handlers registered');

      // Helpers
      if (typeof Element.prototype.nearest === 'function') {
        const status = document.getElementById('inputs-status');
        status.innerHTML = '<span class="check">✓</span> prevent & autosize active';
        document.getElementById('test-inputs').classList.add('pass');
      }

      // UI Components
      if (window.themodal) markPass('test-modals', 'themodal available - click to test');

      // String Utilities
      if (modules?.slugify) {
        import('./string-utilities/slugify.js').then(({ default: slugify }) => {
          document.getElementById('slugify-output').innerHTML =
            `<span class="check">✓</span> "Hello World!" → "${slugify('Hello World!')}"`;
          markPass('test-slugify');
        });
      }

      // FIXED: query.js exports an object, not a function
      if (modules?.['query-params']) {
        import('./string-utilities/query.js').then(({ default: params }) => {
          // params is already the parsed query object
          document.getElementById('query-output').innerHTML =
            `<span class="check">✓</span> Parsed: ${JSON.stringify(params)}`;
          markPass('test-query');
        });
      }

      // DOM Utilities
      if (modules?.['all-js']) {
        import('./dom-utilities/All.js').then(({ default: All }) => {
          document.getElementById('all-output').innerHTML =
            `<span class="check">✓</span> All('div').length = ${All('div').length}`;
          markPass('test-jquery-like');
        });
      }

      // Test insertStyleTag by injecting test-style.css
      if (modules?.['style-injection']) {
        import('./dom-utilities/insertStyleTag.js').then(({ default: insertStyleTag }) => {
          insertStyleTag('./test-style.css');

          // Verify the link tag was created
          setTimeout(() => {
            const linkTag = document.querySelector('link[href*="test-style.css"]');
            if (linkTag) {
              markPass('test-style-injection', 'CSS file injected via insertStyleTag');
            }
          }, 100);
        });
      }

      markPass('test-dom-ready', 'Callbacks registered and fired');

      // Utilities
      if (modules?.mutation) markPass('test-mutation', 'Mutation observer available');
      if (modules?.nearest) markPass('test-nearest', 'nearest() utility loaded');
      if (modules?.cookie) markPass('test-cookie', 'Cookie helper available');
      if (modules?.throttle && modules?.debounce) {
        markPass('test-throttle-debounce', 'Throttle & debounce functions available');
      }

      // Communication
      if (modules?.['send-message'] || modules?.['file-upload']) {
        markPass('test-communication', 'Communication functions available');
      }

      // Behavior collector - update count every second
      let behaviorTestPassed = false;
      setInterval(() => {
        if (window.hyperclayModules?.['behavior-collector']) {
          const collector = window.hyperclayModules['behavior-collector'].default;
          const data = collector.getData();
          const count = data.mousePositions?.length || 0;
          document.getElementById('behavior-collector-count').textContent = count;
          if (count > 0 && !behaviorTestPassed) {
            markPass('test-behavior');
            behaviorTestPassed = true;
          }
        }
      }, 1000);
    }

    // Interactive test functions
    window.testClone = function() {
      const template = document.getElementById('clone-template');
      const cloned = template.cloneNode(true);
      cloned.style.display = 'inline-block';
      cloned.style.marginLeft = '10px';
      document.getElementById('clone-output').appendChild(cloned);
      markPass('test-onclone');
    };

    window.testHelpers = function() {
      const btn = document.getElementById('helper-btn');
      const output = document.getElementById('helpers-output');

      // Test val - set attribute value on element with testattr
      if (btn.val) {
        btn.val.testattr = 'updated';
      }

      // Test text - set text on element with helpertext attribute
      if (btn.text) {
        btn.text.helpertext = '✓ All helpers working';
      }

      // Test nearest - find nearest .test element
      if (btn.nearest) {
        const nearestTest = btn.nearest.test;
        if (nearestTest && nearestTest.classList.contains('test')) {
          output.innerHTML = '<span class="check">✓</span> All helpers working';
          markPass('test-helpers');
        }
      }
    };

    window.testToast = function() {
      import('./ui/toast.js').then(({ default: toast }) => {
        toast('Toast notification working!', 'success');
        markPass('test-toast');
      });
    };

    window.testAsk = function() {
      import('./ui/prompts.js').then(({ ask }) => {
        ask('Enter your name:', (name) => console.log('Name:', name), 'Test User');
      });
    };

    window.testConsent = function() {
      import('./ui/prompts.js').then(({ consent }) => {
        consent('Do you agree?', () => console.log('Agreed'));
      });
    };

    window.testTell = function() {
      import('./ui/prompts.js').then(({ tell }) => {
        tell('This is a tell dialog', 'Now with variadic content support!', 'Each argument becomes a paragraph.');
      });
    };

    window.testSnippet = function() {
      import('./ui/prompts.js').then(({ snippet }) => {
        snippet('Test Code', 'console.log("Hello World");');
      });
    };

    window.testTheModal = function() {
      import('./ui/theModal.js').then(({ default: themodal }) => {
        // Standard SVGs used by prompts.js
        const CLOSE_BUTTON_SVG = `<svg viewBox="0 0 134 134" fill="none" xmlns="http://www.w3.org/2000/svg"><path class="micromodal__close-bg" d="M132 132.5 1 1.5h131v131Z" /><path class="micromodal__close-x" fill-rule="evenodd" clip-rule="evenodd" d="M0 0h3v1.5h1.5V3H6v1.5h1.5V6H9v1.5h1.5V9H12v1.5h1.5V12H15v1.5h1.5V15H18v1.5h1.5V18H21v1.5h1.5V21H24v1.5h1.5V24H27v1.5h1.5V27H30v1.5h1.5V30H33v1.5h1.5V33H36v1.5h1.5V36H39v1.5h1.5V39H42v1.5h1.5V42H45v1.5h1.5V45H48v1.5h1.5V48H51v1.5h1.5V51H54v1.5h1.5V54H57v1.5h1.5V57H60v1.5h1.5V60H63v1.5h1.5V63H66v1.5h1.5V66H69v1.5h1.5V69H72v1.5h1.5V72H75v1.5h1.5V75H78v1.5h1.5V78H81v1.5h1.5V81H84v1.5h1.5V84H87v1.5h1.5V87H90v1.5h1.5V90H93v1.5h1.5V93H96v1.5h1.5V96H99v1.5h1.5V99h1.5v1.5h1.5v1.5h1.5v1.5h1.5v1.5h1.5v1.5h1.5v1.5h1.5v1.5h1.5v1.5h1.5v1.5h1.5v1.5h1.5v1.5h1.5v1.5h1.5v1.5h1.5v1.5h1.5v1.5h1.5v1.5h1.5v1.5h1.5v1.5h1.5v1.5h1.5v1.5h1.5v1.5h1.5v3h-3V132H129v-1.5h-1.5V129H126v-1.5h-1.5V126H123v-1.5h-1.5V123H120v-1.5h-1.5V120H117v-1.5h-1.5V117H114v-1.5h-1.5V114H111v-1.5h-1.5V111H108v-1.5h-1.5V108H105v-1.5h-1.5V105H102v-1.5h-1.5V102H99v-1.5h-1.5V99H96v-1.5h-1.5V96H93v-1.5h-1.5V93H90v-1.5h-1.5V90H87v-1.5h-1.5V87H84v-1.5h-1.5V84H81v-1.5h-1.5V81H78v-1.5h-1.5V78H75v-1.5h-1.5V75H72v-1.5h-1.5V72H69v-1.5h-1.5V69H66v-1.5h-1.5V66H63v-1.5h-1.5V63H60v-1.5h-1.5V60H57v-1.5h-1.5V57H54v-1.5h-1.5V54H51v-1.5h-1.5V51H48v-1.5h-1.5V48H45v-1.5h-1.5V45H42v-1.5h-1.5V42H39v-1.5h-1.5V39H36v-1.5h-1.5V36H33v-1.5h-1.5V33H30v-1.5h-1.5V30H27v-1.5h-1.5V27H24v-1.5h-1.5V24H21v-1.5h-1.5V21H18v-1.5h-1.5V18H15v-1.5h-1.5V15H12v-1.5h-1.5V12H9v-1.5H7.5V9H6V7.5H4.5V6H3V4.5H1.5V3H0V0ZM108.8 22h5.2v5.1h-2.6v2.6H109v2.6h-2.6v2.6h-2.6v2.5h-2.6v5.2h2.6V45h2.6v2.6h2.6v2.6h2.5v2.6h2.6V58h-5.1v-2.6h-2.6V53h-2.6v-2.6h-2.6v-2.6h-2.5v-2.6h-5.2v2.6H91v2.6h-2.6v2.6h-2.6v2.5h-2.6V58H78v-5.1h2.6v-2.6H83v-2.6h2.6v-2.6h2.6v-2.5h2.6v-5.2h-2.6V35h-2.6v-2.6h-2.6v-2.6h-2.5v-2.6H78V22h5.2v2.6h2.5V27h2.6v2.6h2.6v2.6h2.5v2.6h5.2v-2.6h2.5v-2.6h2.6v-2.6h2.6v-2.5h2.5V22Z" /></svg>`;
        const CONFIRM_BUTTON_SVG = `<div style="width: 28px;"><svg viewBox="0 0 60 33" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M34.5 0.75H43.5V5.25H49V9.75H54.5V14.25H60V18.75H54.5V23.25H49V27.75H43.5V32.25H34.5V27.75H40V23.25H45.5V18.75H0V14.25H45.5V9.75H40V5.25H34.5V0.75Z" fill="white"/></svg></div>`;

        // Follow the same pattern as prompts.js
        themodal.html = `
          <div class="micromodal__heading">theModal Test</div>
          <p style="margin-bottom: 10px;">This modal uses the same pattern as prompts.js.</p>
          <p style="color: #888;">Click the arrow button or press Enter to confirm.</p>
        `;
        themodal.closeHtml = CLOSE_BUTTON_SVG;
        themodal.yes = CONFIRM_BUTTON_SVG;

        themodal.onYes(() => {
          markPass('test-modals', 'theModal works!');
          return true; // Allow close
        });

        themodal.onNo = () => {
          console.log('Modal closed');
        };

        themodal.open();
      });
    };

    window.testClipboard = function() {
      import('./string-utilities/copy-to-clipboard.js').then(({ default: copy }) => {
        const randomId = Math.random().toString(36).substring(2, 8);
        const testText = `Copy to clipboard test id: ${randomId}`;
        copy(testText);
        import('./ui/toast.js').then(({ default: toast }) => {
          toast(`Copied: "${testText}"`, 'success');
          markPass('test-clipboard');
        });
      });
    };
  </script>
</body>
</html>
